@page "/admin"
@rendermode @(new InteractiveServerRenderMode())
@layout AdminLayout
@inject IMenuRepository MenuRepository
@inject IMenuScrapingService MenuScrapingService
@inject ITimeZoneService TimeZoneService
@inject IHttpContextAccessor HttpContextAccessor
@using Meyers.Core.Interfaces
@using Meyers.Core.Models
@using Meyers.Core.Utilities
@implements IDisposable

<PageTitle>Admin Dashboard - Meyers Menu Calendar</PageTitle>


<div class="max-w-6xl mx-auto p-4">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Admin Dashboard</h1>
        <p class="text-slate-600 dark:text-slate-300">Monitor scraping health and system status</p>
    </div>

    @if (!componentInitialized)
    {
        <div class="card p-8 max-w-md mx-auto text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mx-auto mb-4"></div>
            <p class="text-slate-600 dark:text-slate-300">Loading...</p>
        </div>
    }
    else if (!isAuthorized)
    {
        <div class="card p-8 max-w-md mx-auto text-center">
            <h2 class="text-xl font-semibold mb-4 text-slate-900 dark:text-white">Access Required</h2>

            <form @onsubmit="CheckAccess" @onsubmit:preventDefault="true">
                <div class="mb-4">
                    <input type="password" @bind="secretInput"
                           placeholder="Enter admin secret"
                           class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg 
                                  bg-white dark:bg-slate-800 text-slate-900 dark:text-white
                                  focus:ring-2 focus:ring-teal-500 focus:border-teal-500"/>
                </div>
                <button type="submit" class="btn-primary w-full">
                    Access Dashboard
                </button>
            </form>
            @if (authError)
            {
                <p class="text-red-600 text-sm mt-2">Invalid secret</p>
            }
        </div>
    }
    else
    {
        <!-- System Status -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-6">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-3">üìä</span>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Total Menu Entries</h3>
                </div>
                @if (totalEntriesLoading)
                {
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-teal-600 mr-2"></div>
                        <p class="text-lg text-slate-500 dark:text-slate-400">Loading...</p>
                    </div>
                }
                else
                {
                    <p class="text-3xl font-bold text-teal-600">@totalEntries</p>
                }
            </div>

            <div class="card p-6">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-3">üïí</span>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Last Update</h3>
                </div>
                <p class="text-sm text-slate-600 dark:text-slate-300 tabular-nums">@lastUpdateDisplay</p>
            </div>

            <div class="card p-6">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-3">üìã</span>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Active Menu Types</h3>
                </div>
                <p class="text-3xl font-bold text-teal-600">@activeMenuTypes</p>
            </div>

            <div class="card p-6">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-3">üìÖ</span>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Date Range</h3>
                </div>
                @if (dateRangeLoading)
                {
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-teal-600 mr-2"></div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Loading...</p>
                    </div>
                }
                else
                {
                    <div class="text-sm text-slate-600 dark:text-slate-300">
                        @if (firstMenuDate.HasValue && lastMenuDate.HasValue)
                        {
                            <p><strong>First:</strong> @firstMenuDate.Value.ToString("MMM d, yyyy")</p>
                            <p><strong>Last:</strong> @lastMenuDate.Value.ToString("MMM d, yyyy")</p>
                        }
                        else
                        {
                            <p class="text-slate-400">No menu data</p>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Menu Type Health -->
        <div class="card p-6 mb-8">
            <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                <span class="text-2xl mr-3">üè•</span>
                Menu Type Health
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="border-b border-slate-200 dark:border-slate-700">
                    <tr>
                        <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">Menu Type</th>
                        <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">Today</th>
                        <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">Tomorrow</th>
                        <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">This Week</th>
                        <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">Next Week</th>
                        <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var health in menuHealth)
                    {
                        <tr class="border-b border-slate-100 dark:border-slate-800">
                            <td class="py-3 px-2 font-medium text-slate-900 dark:text-white">@health.MenuTypeName</td>
                            <td class="py-3 px-2">
                                    <span
                                        class="pill @(health.HasToday ? "bg-green-100 text-green-800 ring-green-300/60" : "bg-red-100 text-red-800 ring-red-300/60")">
                                        @(health.HasToday ? "‚úì" : "‚úó")
                                    </span>
                            </td>
                            <td class="py-3 px-2">
                                    <span
                                        class="pill @(health.HasTomorrow ? "bg-green-100 text-green-800 ring-green-300/60" : "bg-yellow-100 text-yellow-800 ring-yellow-300/60")">
                                        @(health.HasTomorrow ? "‚úì" : "‚úó")
                                    </span>
                            </td>
                            <td class="py-3 px-2 text-slate-600 dark:text-slate-300">@health.EntriesThisWeek/5</td>
                            <td class="py-3 px-2 text-slate-600 dark:text-slate-300">@health.EntriesNextWeek/5</td>
                            <td class="py-3 px-2">
                                    <span class="pill @GetHealthStatusClass(health)">
                                        @GetHealthStatus(health)
                                    </span>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Scraping Logs -->
        <div class="card p-6 mb-8">
            <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                <span class="text-2xl mr-3">üìã</span>
                Recent Scraping Operations
            </h3>
            @if (scrapingLogsLoading)
            {
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mr-2"></div>
                    <p class="text-slate-600 dark:text-slate-300">Loading scraping logs...</p>
                </div>
            }
            else if (scrapingLogs.Count == 0)
            {
                <p class="text-slate-600 dark:text-slate-300 text-center py-8">No scraping operations recorded yet.</p>
            }
            else
            {
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="border-b border-slate-200 dark:border-slate-700">
                        <tr>
                            <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">Timestamp
                            </th>
                            <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">Source</th>
                            <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">Request</th>
                            <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">Parsing</th>
                            <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">New Items
                            </th>
                            <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">Duration</th>
                            <th class="text-left py-3 px-2 font-medium text-slate-700 dark:text-slate-300">Error</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var log in scrapingLogs)
                        {
                            <tr class="border-b border-slate-100 dark:border-slate-800">
                                <td class="py-3 px-2 text-slate-600 dark:text-slate-300 tabular-nums">
                                    @log.Timestamp.ToLocalTime().ToString("MMM d, HH:mm:ss")
                                </td>
                                <td class="py-3 px-2">
                                    <span class="pill @GetSourceClass(log.Source)">
                                        @log.Source
                                    </span>
                                </td>
                                <td class="py-3 px-2">
                                    <span
                                        class="pill @(log.RequestSuccessful ? "bg-green-100 text-green-800 ring-green-300/60" : "bg-red-100 text-red-800 ring-red-300/60")">
                                        @(log.RequestSuccessful ? "‚úì" : "‚úó")
                                    </span>
                                </td>
                                <td class="py-3 px-2">
                                    <span
                                        class="pill @(log.ParsingSuccessful ? "bg-green-100 text-green-800 ring-green-300/60" : "bg-red-100 text-red-800 ring-red-300/60")">
                                        @(log.ParsingSuccessful ? "‚úì" : "‚úó")
                                    </span>
                                </td>
                                <td class="py-3 px-2 text-slate-600 dark:text-slate-300 tabular-nums">
                                    @log.NewMenuItemsCount
                                </td>
                                <td class="py-3 px-2 text-slate-600 dark:text-slate-300 tabular-nums">
                                    @($"{log.Duration.TotalSeconds:F1}s")
                                </td>
                                <td class="py-3 px-2 text-slate-600 dark:text-slate-300">
                                    @if (!string.IsNullOrEmpty(log.ErrorMessage))
                                    {
                                        <span class="text-red-600 dark:text-red-400 text-xs" title="@log.ErrorMessage">
                                            @(log.ErrorMessage.Length > 30 ? log.ErrorMessage[..30] + "..." : log.ErrorMessage)
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-slate-400">-</span>
                                    }
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        <!-- Actions -->
        <div class="card p-6">
            <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                <span class="text-2xl mr-3">‚ö°</span>
                Actions
            </h3>
            <div class="flex flex-wrap gap-4">
                <button @onclick="RefreshMenus" disabled="@isRefreshing"
                        class="btn-primary @(isRefreshing ? "opacity-50 cursor-not-allowed" : "")">
                    @(isRefreshing ? "Refreshing..." : "üîÑ Refresh Menus")
                </button>
                <button @onclick="TestScraping" disabled="@isTesting"
                        class="btn-ghost @(isTesting ? "opacity-50 cursor-not-allowed" : "")">
                    @(isTesting ? "Testing..." : "üß™ Test Scraping")
                </button>
            </div>

            @if (!string.IsNullOrEmpty(actionResult))
            {
                <div
                    class="mt-4 p-4 rounded-lg @(actionResult.Contains("Error") ? "bg-red-50 text-red-800 border border-red-200" : "bg-green-50 text-green-800 border border-green-200")">
                    <pre class="whitespace-pre-wrap text-sm">@actionResult</pre>
                </div>
            }
        </div>
    }
</div>


@code {
    private bool isAuthorized;
    private string secretInput = "";
    private bool authError;
    private bool componentInitialized;

    private int totalEntries;
    private bool totalEntriesLoading = true;
    private int activeMenuTypes;
    private DateTime? lastUpdate;
    private string lastUpdateDisplay = "Never";
    private DateTime? firstMenuDate;
    private DateTime? lastMenuDate;
    private bool dateRangeLoading = true;
    private readonly List<MenuTypeHealth> menuHealth = new();
    private readonly List<ScrapingLog> scrapingLogs = new();
    private bool scrapingLogsLoading = true;

    private bool isRefreshing;
    private bool isTesting;
    private string actionResult = "";

    private Timer? updateTimer;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("Admin component initializing...");

        try
        {
            // Check if already authorized via query parameter
            var request = HttpContextAccessor.HttpContext?.Request;
            if (request?.Query.ContainsKey("secret") == true)
            {
                var querySecret = request.Query["secret"].ToString();
                Console.WriteLine($"Found query secret: {querySecret}");
                if (IsValidSecret(querySecret))
                {
                    Console.WriteLine("Query secret is valid, loading dashboard...");
                    isAuthorized = true;
                    await LoadDashboardData();
                    StartUpdateTimer();
                }
            }
            else
            {
                Console.WriteLine("No query secret found");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OnInitializedAsync: {ex.Message}");
        }

        Console.WriteLine($"Initialization complete. isAuthorized: {isAuthorized}");

        componentInitialized = true;
        StateHasChanged();
    }


    private async Task CheckAccess()
    {
        Console.WriteLine($"CheckAccess called with secret: {secretInput}");
        if (IsValidSecret(secretInput))
        {
            Console.WriteLine("Secret is valid, authorizing...");
            isAuthorized = true;
            authError = false;
            await LoadDashboardData();
            StartUpdateTimer();
        }
        else
        {
            Console.WriteLine("Secret is invalid");
            authError = true;
        }

        StateHasChanged(); // Force UI update
    }


    private bool IsValidSecret(string secret)
    {
        var expectedSecret = Environment.GetEnvironmentVariable("REFRESH_SECRET") ?? "admin123";
        return secret == expectedSecret;
    }

    private async Task LoadDashboardData()
    {
        try
        {
            var today = TimeZoneService.GetCopenhagenDate();
            var tomorrow = today.AddDays(1);

            // Calculate week boundaries
            var thisWeekStart = today.AddDays(-(int)today.DayOfWeek + 1); // Monday of this week
            var thisWeekEnd = thisWeekStart.AddDays(4); // Friday of this week
            var nextWeekStart = thisWeekStart.AddDays(7); // Monday of next week
            var nextWeekEnd = nextWeekStart.AddDays(4); // Friday of next week

            // Get data for a broader range
            var startDate = thisWeekStart.AddDays(-7); // Include last week for context
            var endDate = nextWeekEnd;

            // Get basic stats - load efficiently
            var allEntries = await MenuRepository.GetMenusForDateRangeAsync(startDate, endDate);
            var menuTypes = await MenuRepository.GetMenuTypesAsync();
            activeMenuTypes = menuTypes.Count;

            lastUpdate = await MenuRepository.GetLastUpdateTimeAsync();
            UpdateLastUpdateDisplay();

            // Calculate health for each menu type
            menuHealth.Clear();
            foreach (var menuType in menuTypes)
            {
                var entries = allEntries.Where(e => e.MenuTypeId == menuType.Id).ToList();
                var health = new MenuTypeHealth
                {
                    MenuTypeName = menuType.Name,
                    HasToday = entries.Any(e => e.Date.Date == today),
                    HasTomorrow = entries.Any(e => e.Date.Date == tomorrow),
                    EntriesThisWeek = entries.Count(e => e.Date.Date >= thisWeekStart && e.Date.Date <= thisWeekEnd),
                    EntriesNextWeek = entries.Count(e => e.Date.Date >= nextWeekStart && e.Date.Date <= nextWeekEnd)
                };
                menuHealth.Add(health);
            }

            // Load total entries count, date range, and scraping logs separately and asynchronously for better performance
            _ = LoadTotalEntriesCount();
            _ = LoadDateRange();
            _ = LoadScrapingLogs();
        }
        catch (Exception ex)
        {
            actionResult = $"Error loading dashboard data: {ex.Message}";
        }
    }

    private async Task LoadTotalEntriesCount()
    {
        try
        {
            totalEntries = await MenuRepository.GetTotalMenuEntriesCountAsync();
            totalEntriesLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            actionResult = $"Error loading total entries count: {ex.Message}";
            totalEntriesLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadDateRange()
    {
        try
        {
            firstMenuDate = await MenuRepository.GetFirstMenuDateAsync();
            lastMenuDate = await MenuRepository.GetLastMenuDateAsync();
            dateRangeLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            actionResult = $"Error loading date range: {ex.Message}";
            dateRangeLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadScrapingLogs()
    {
        try
        {
            var logs = await MenuRepository.GetRecentScrapingLogsAsync(20);
            scrapingLogs.Clear();
            scrapingLogs.AddRange(logs);
            scrapingLogsLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            actionResult = $"Error loading scraping logs: {ex.Message}";
            scrapingLogsLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshMenus()
    {
        isRefreshing = true;
        actionResult = "";
        StateHasChanged();

        try
        {
            var menuDays = await MenuScrapingService.ScrapeMenuAsync(true, "Manual");
            await LoadDashboardData(); // Refresh the data

            actionResult = $"‚úÖ Successfully refreshed menus!\n\nScraped {menuDays.Count} menu entries across {menuDays.GroupBy(m => m.MenuType).Count()} menu types.";
        }
        catch (Exception ex)
        {
            actionResult = $"‚ùå Error refreshing menus: {ex.Message}";
        }
        finally
        {
            isRefreshing = false;
            StateHasChanged();
        }
    }

    private async Task TestScraping()
    {
        isTesting = true;
        actionResult = "";
        StateHasChanged();

        try
        {
            var menuDays = await MenuScrapingService.ScrapeMenuAsync();
            var groupedByType = menuDays.GroupBy(m => m.MenuType).ToList();

            var result = "üß™ Test Scraping Results:\n\n";
            result += $"Total entries scraped: {menuDays.Count}\n";
            result += $"Menu types found: {groupedByType.Count}\n\n";

            foreach (var group in groupedByType)
            {
                result += $"üìã {group.Key}: {group.Count()} entries\n";
                var dates = group.Select(m => m.Date.ToString("yyyy-MM-dd")).Distinct().OrderBy(d => d);
                result += $"   Dates: {string.Join(", ", dates)}\n\n";
            }

            actionResult = result;
        }
        catch (Exception ex)
        {
            actionResult = $"‚ùå Error testing scraping: {ex.Message}";
        }
        finally
        {
            isTesting = false;
            StateHasChanged();
        }
    }

    private void StartUpdateTimer()
    {
        updateTimer?.Dispose();
        updateTimer = new Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                UpdateLastUpdateDisplay();
                StateHasChanged();
            });
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private void UpdateLastUpdateDisplay()
    {
        if (lastUpdate == null)
        {
            lastUpdateDisplay = "Never";
            return;
        }

        var localTime = lastUpdate.Value.ToLocalTime();
        lastUpdateDisplay = TimeFormatHelper.FormatTimeAgo(localTime);
    }

    private string GetHealthStatus(MenuTypeHealth health)
    {
        if (!health.HasToday) return "Critical";
        if (!health.HasTomorrow) return "Warning";
        if (health.EntriesThisWeek < 3) return "Poor";
        if (health.EntriesNextWeek < 3) return "Concerning";
        return "Healthy";
    }

    private string GetHealthStatusClass(MenuTypeHealth health)
    {
        return GetHealthStatus(health) switch
        {
            "Critical" => "bg-red-100 text-red-800 ring-red-300/60",
            "Warning" => "bg-yellow-100 text-yellow-800 ring-yellow-300/60",
            "Poor" => "bg-orange-100 text-orange-800 ring-orange-300/60",
            "Concerning" => "bg-purple-100 text-purple-800 ring-purple-300/60",
            _ => "bg-green-100 text-green-800 ring-green-300/60"
        };
    }

    private string GetSourceClass(string source)
    {
        return source switch
        {
            "Background" => "bg-blue-100 text-blue-800 ring-blue-300/60",
            "Manual" => "bg-purple-100 text-purple-800 ring-purple-300/60",
            "API" => "bg-teal-100 text-teal-800 ring-teal-300/60",
            _ => "bg-slate-100 text-slate-800 ring-slate-300/60"
        };
    }

    private class MenuTypeHealth
    {
        public string MenuTypeName { get; set; } = "";
        public bool HasToday { get; set; }
        public bool HasTomorrow { get; set; }
        public int EntriesThisWeek { get; set; }
        public int EntriesNextWeek { get; set; }
    }

    public void Dispose()
    {
        updateTimer?.Dispose();
    }

}